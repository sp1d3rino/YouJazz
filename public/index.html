<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gypsy Jazz Backing Track Composer</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="libs/kali.min.js"></script>
  <link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
  <link rel="shortcut icon" href="/images/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
  <link rel="manifest" href="/images/site.webmanifest" />

  <!-- CRITICAL: Hide page content until auth check completes -->
  <style>
    body.auth-checking {
      visibility: hidden;
    }

    #auth-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      transition: opacity 0.3s ease;
    }

    #auth-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .auth-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: #e91e63;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>

  <!-- CRITICAL: Run auth check BEFORE page renders -->
  <script src="auth.js"></script>
</head>

<body class="auth-checking">
  <!-- Auth loader overlay -->
  <div id="auth-loader">
    <div class="auth-spinner"></div>
  </div>
  <div class="select-wrapper">
    <select id="song-list">
      <option value="">— Load Song —</option>
    </select>
  </div>
  <button id="filter-favourites" class="toggle-btn favourite-filter-btn" title="Show Favourites Only">
    <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polygon
        points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
    </svg>
  </button>
  <div class="container">
    <header>
      <div id="user-info" style="position:absolute;top:20px;right:20px;text-align:right;cursor:pointer;">
        <!--<span id="user-name" style="font-size:1.2em;"></span><br>-->
        <img id="user-pic" width="40" height="40" style="border-radius:50%;margin-top:8px;vertical-align:middle;">
        <!-- Dropdown menu (nascosto di default) -->
        <div id="user-dropdown"
          style="display:none;position:absolute;top:70px;right:0;background:#222;border:2px solid #01010e;border-radius:8px;padding:10px 16px;min-width:140px;z-index:9999;box-shadow:0 8px 20px rgba(0,0,0,0.6);">
          <div style="padding:8px 0;color:#eee;font-weight:bold;border-bottom:1px solid #444;margin-bottom:8px;">
            <span id="user-name-dropdown"></span>
          </div>
          <div onclick="Auth.logout()"
            style="padding:8px 12px;color:#ff6b6b;cursor:pointer;border-radius:6px;transition:0.2s;"
            onmouseover="this.style.background='#444'" onmouseout="this.style.background='transparent'">
            Logout
          </div>
        </div>
      </div>
    </header>

    <div class="controls">
      <button id="new-song" class="icon-btn new-btn" title="New Song">
        <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14" />
        </svg>
      </button>

      <button id="save-song" class="icon-btn save-btn" title="Save">
        <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
          <polyline points="17 21 17 13 7 13 7 21" />
          <polyline points="7 3 7 8 15 8" />
        </svg>
      </button>

      <button id="save-as-song" class="icon-btn save-as-btn" title="Save As">
        <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
          <polyline points="17 21 17 13 7 13 7 21" />
          <polyline points="7 3 7 8 15 8" />
          <circle cx="17" cy="7" r="3" fill="currentColor" />
        </svg>
      </button>

      <button id="delete-song" class="icon-btn delete-btn" title="Delete">
        <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
      </button>

      <button id="ai-reharmonize" class="icon-btn ai-btn" title="AI Reharmonize">
        <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <circle cx="9" cy="10" r="1" fill="currentColor" />
          <circle cx="15" cy="10" r="1" fill="currentColor" />
          <path d="M9 16c1 1 2 1.5 3 1.5s2-.5 3-1.5" />
          <path d="M12 2v3M12 19v3M2 12h3M19 12h3" />
        </svg>

      </button>

      <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
        <input type="text" id="song-title" placeholder="Song name" value="Song name" />
        <button id="public-toggle-btn" class="toggle-btn public-btn" title="Public/Private">
          <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path
              d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
          </svg>
        </button>
      </div>

      <label>BPM: <span id="bpm-value">120</span></label>
      <input type="range" id="bpm-slider" min="40" max="300" value="120" step="5">


    </div>

    <div class="main">
      <aside class="chord-palette">
        <div class="control-group">
          <h3>Rhythm Style</h3>
          <div class="style-selector"></div>
        </div>
        <h3>Chords</h3>
        <div class="chord-list"></div>

        <h3 style="margin-top: 30px; color: #aaa;">Chord Extensions</h3>
        <div class="extension-list"></div>
      </aside>

      <section id="lead-sheet"></section>

      <aside class="player-controls">
        <button id="play" class="icon-btn play-btn" title="Play">
          <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="5 3 19 12 5 21 5 3" />
          </svg>
        </button>

        <button id="stop" class="icon-btn stop-btn" title="Stop">
          <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor">
            <rect x="6" y="6" width="12" height="12" />
          </svg>
        </button>

        <button id="add-row" class="icon-btn add-row-btn" title="Add Row">
          <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <line x1="3" y1="9" x2="21" y2="9" />
            <line x1="3" y1="15" x2="21" y2="15" />
            <line x1="12" y1="15" x2="12" y2="21" />
            <line x1="9" y1="18" x2="15" y2="18" />
          </svg>
        </button>
      </aside>
    </div>
  </div>

  <!-- Spinner durante caricamento audio -->
  <div id="audio-spinner" class="audio-spinner hidden">
    <div class="spinner"></div>
    <p>Generating audio...</p>
  </div>

  <!-- Modal creazione griglia (nascosto all'avvio) -->
  <div id="grid-setup-modal" class="modal hidden">
    <div class="modal-content">
      <h2>New Lead Sheet</h2>
      <p>Choose grid size:</p>
      <div class="grid-inputs">
        <label>Rows:
          <input type="number" id="grid-rows" min="1" max="10" value="4">
        </label>
        <label>Columns:
          <input type="number" id="grid-cols" min="1" max="10" value="4">
        </label>
      </div>
      <button id="create-grid">Create Grid</button>
    </div>
  </div>

  <script src="player.js"></script>
  <script src="db.js"></script>
  <script src="app.js"></script>
  <script src="message.js"></script>

  <!-- YOUJAZZ MESSAGE BOX -->
  <div class="yj-message-overlay" id="yj-message">
    <div class="yj-message-box">
      <div class="yj-message-icon" id="yj-icon">♪</div>
      <h2 class="yj-message-title" id="yj-title">YouJazz</h2>
      <p class="yj-message-text" id="yj-text"></p>
      <button class="yj-message-btn" id="yj-ok">OK</button>
    </div>
  </div>
</body>

</html>